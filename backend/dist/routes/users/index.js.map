{"version":3,"sources":["../../../src/routes/users/index.js"],"names":["router","csrfProtection","cookie","customCallback","req","res","passport","session","email","user","facebook","naver","social","cookieOptions","maxAge","rightProvider","displayName","redirect","end","middlewareWithPassport","method","authenticate","get","findUserByEmail","post","logout"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;;AAEA,MAAMA,SAAS,sBAAf;AACA,MAAMC,iBAAiB,qBAAK,EAAEC,QAAQ,IAAV,EAAL,CAAvB;;AAEA,MAAMC,iBAAiB,CAACC,GAAD,EAAMC,GAAN,KAAc;AACnC,QAAM,EAAEC,QAAF,KAAeF,IAAIG,OAAzB;AACA,QAAM,EAAEC,KAAF,KAAYJ,IAAIK,IAAtB;AACA,QAAM,EAAEC,QAAF,EAAYC,KAAZ,KAAsBP,IAAIK,IAAJ,CAASG,MAArC;AACA,QAAMC,gBAAgB;AACpBC,YAAQ,OAAO,EAAP,GAAY,EAAZ,GAAiB;AADL,GAAtB;;AAIA,QAAMC,gBAAgB,MAAM;AAC1B,QAAG,uBAAQL,QAAR,CAAH,EAAsB;AACpB,aAAOC,KAAP;AACD;AACD,WAAOD,QAAP;AACD,GALD;;AAOA,MAAIN,IAAIK,IAAJ,CAASG,MAAb,EAAqB;AACnBP,QAAIH,MAAJ,CACE,MADF,EAEG,QAAOI,SAASG,IAAK,UAASD,QAAQA,KAAR,GAAgBO,gBAAgBC,WAAY,GAF7E,EAEiFH,aAFjF;AAGAR,QAAIY,QAAJ,CAAa,GAAb;AACD,GALD,MAKO;AACLZ,QAAIH,MAAJ,CACE,MADF,EAEG,SAAQI,SAASG,IAAK,YAAWD,QAAQA,KAAR,GAAgBO,gBAAgBC,WAAY,IAFhF,EAEqFH,aAFrF;AAGAR,QAAIa,GAAJ;AACD;AACF,CA1BD;;AA4BA,MAAMC,yBAA0BC,MAAD,IAAY,gCAAQ;AACjD;AACA,mBAASC,YAAT,CAAsBD,MAAtB,CAFiD,EAGjDjB,cAHiD,CAAR,CAA3C;;AAMAH,OAAOsB,GAAP,CAAW,eAAX,EAA4B,eAAYC,eAAxC;;AAEAvB,OAAOwB,IAAP,CAAY,SAAZ,EACEL,uBAAuB,cAAvB,CADF;;AAGAnB,OAAOwB,IAAP,CAAY,SAAZ,EACEL,uBAAuB,cAAvB,CADF;;AAGAnB,OAAOsB,GAAP,CAAW,eAAX,EACEH,uBAAuB,gBAAvB,CADF;;AAGAnB,OAAOsB,GAAP,CAAW,iBAAX,EACEH,uBAAuB,gBAAvB,CADF;;AAGAnB,OAAOsB,GAAP,CAAW,kBAAX,EACEH,uBAAuB,mBAAvB,CADF;;AAGAnB,OAAOsB,GAAP,CAAW,oBAAX,EACEH,uBAAuB,mBAAvB,CADF;;AAGAnB,OAAOsB,GAAP,CAAW,SAAX,EAAsB,eAAYG,MAAlC;;kBAEezB,M","file":"index.js","sourcesContent":["import { Router } from 'express'\nimport csrf from 'csurf'\nimport passport from 'passport'\nimport userControl from './user.controller'\nimport { compose } from 'compose-middleware'\nimport isEmpty from 'lodash/isEmpty'\n\nconst router = Router()\nconst csrfProtection = csrf({ cookie: true })\n\nconst customCallback = (req, res) => {\n  const { passport } = req.session\n  const { email } = req.user\n  const { facebook, naver } = req.user.social\n  const cookieOptions = {\n    maxAge: 1000 * 60 * 60 * 5,\n  }\n\n  const rightProvider = () => {\n    if(isEmpty(facebook)) {\n      return naver\n    }\n    return facebook\n  }\n\n  if (req.user.social) {\n    res.cookie(\n      'user', \n      `{sid:${passport.user}, user:${email ? email : rightProvider().displayName}}`, cookieOptions)\n    res.redirect('/')\n  } else {\n    res.cookie(\n      'user', \n      `{sid:'${passport.user}', user:'${email ? email : rightProvider().displayName}'}`, cookieOptions)\n    res.end()\n  }\n}\n\nconst middlewareWithPassport = (method) => compose([\n  //csrfProtection,\n  passport.authenticate(method),\n  customCallback,\n])\n\nrouter.get('/email/:email', userControl.findUserByEmail)\n\nrouter.post('/signup',\n  middlewareWithPassport('local-signup'))\n\nrouter.post('/signin', \n  middlewareWithPassport('local-signin'))\n\nrouter.get('/signup/naver', \n  middlewareWithPassport('provider:naver'))\n\nrouter.get('/naver/callback',\n  middlewareWithPassport('provider:naver'))\n\nrouter.get('/signup/facebook', \n  middlewareWithPassport('provider:facebook'))\n\nrouter.get('/facebook/callback', \n  middlewareWithPassport('provider:facebook'))\n\nrouter.get('/logout', userControl.logout)\n\nexport default router\n"]}